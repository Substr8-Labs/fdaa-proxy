# TowerHQ FDAA Proxy Stack - STAGING
# 
# Isolated staging environment - test here before prod
#
# Deploy: docker stack deploy -c towerhq-staging-stack.yml towerhq-staging

version: "3.8"

networks:
  towerhq-staging:
    driver: overlay
    attachable: true

volumes:
  fdaa-data-staging:
  acc-keys-staging:

configs:
  acc-public-key-staging:
    file: /home/node/.openclaw/secrets/acc-keys/public.key
  shared-gateway-auth-staging:
    external: true
    name: shared-gateway-auth  # Reuse same auth config

secrets:
  acc-private-key-staging:
    file: /home/node/.openclaw/secrets/acc-keys/private.key

services:
  # FDAA Proxy - Governed OpenClaw Gateway
  fdaa-proxy:
    image: fdaa-proxy:staging
    command:
      - fdaa-proxy
      - openclaw
      - start
      - --host=0.0.0.0
      - --port=8800
      - --upstream=ws://shared-gateway:18789
      - --audit-db=/data/audit.db
      - --acc-key=/run/configs/public.key
      - --acc-issuer=https://acc.substr8labs.com
    environment:
      - OPENCLAW_GATEWAY_TOKEN=towerhq-staging-token-2026
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=fdaa-proxy-staging
    configs:
      - source: acc-public-key-staging
        target: /run/configs/public.key
    volumes:
      - fdaa-data-staging:/data
    networks:
      - towerhq-staging
    deploy:
      mode: replicated
      replicas: 1
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost',8800)); s.close()"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Shared OpenClaw Gateway (upstream)
  shared-gateway:
    image: towerhq/gateway-shared:staging
    ports:
      - "19001:18789"  # STAGING: 19001 instead of 19000
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    configs:
      - source: shared-gateway-auth-staging
        target: /runtime-state/agents/main/agent/auth-profiles.json
    networks:
      - towerhq-staging
    deploy:
      mode: replicated
      replicas: 1
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:18789/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 5s
      retries: 3

  # HTTP Bridge - REST to WebSocket
  bridge:
    image: towerhq/bridge:staging
    ports:
      - "13100:3100"  # STAGING: 13100 instead of 3100
    environment:
      - BRIDGE_PORT=3100
      - BRIDGE_SECRET=${BRIDGE_SECRET}
      - GATEWAY_URL=ws://fdaa-proxy:8800
      - GATEWAY_TOKEN=towerhq-staging-token-2026
    networks:
      - towerhq-staging
    deploy:
      mode: replicated
      replicas: 1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3100/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Jaeger Tracing (staging shares with prod to save resources)
  # Comment out if you want isolated tracing
  # jaeger:
  #   image: jaegertracing/all-in-one:1.54
  #   ports:
  #     - "16687:16686"  # STAGING: 16687 instead of 16686
  #   environment:
  #     - COLLECTOR_OTLP_ENABLED=true
  #   networks:
  #     - towerhq-staging

  # Verification UI
  verify:
    image: fdaa-proxy:staging
    command:
      - fdaa-proxy
      - verify
      - serve
      - --host=0.0.0.0
      - --port=8080
      - --jaeger-url=http://jaeger:16686
      - --dct-path=/data
    ports:
      - "18080:8080"  # STAGING: 18080 instead of 8080
    volumes:
      - fdaa-data-staging:/data:ro
    networks:
      - towerhq-staging
    deploy:
      mode: replicated
      replicas: 1
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost',8080)); s.close()"]
      interval: 30s
      timeout: 5s
      retries: 3
